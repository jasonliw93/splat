<!DOCTYPE html>
<html>
<head>
  <title>apptests.js</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <link rel="stylesheet" media="all" href="../doc-style.css" />
  <script src="../doc-filelist.js"></script>
  <script>
    var relativeDir = "../", thisFile = "courses/courses/cscc09f15/liwyanch/a2/app//test/apptests.js", defaultSidebar = true;
  </script>
  <script src="../doc-script.js"></script>
</head>
<body>
  <div id="sidebar_wrapper">
    <div id="sidebar_switch">
      <span class="tree">Files</span>
      <span class="headings">Headings</span>
    </div>
    <div id="tree"></div>
    <div id="headings">
    </div>
  </div>
  <div id="sidebar-toggle"></div>
  <div id="container"><div class="background highlight"></div>
<table cellpadding="0" cellspacing="0">
  <tbody>
      <tr>
        <td class="docs">
          <h1>apptests.js</h1>
        </td>
        <td class="code highlight"></td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-1" id="section-1">&#182;</a>
</div>

        </td>
        <td class="code highlight"><div class="highlight"><pre><span class="nx">QUnit</span><span class="p">.</span><span class="nx">jUnitReport</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">report</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">report</span><span class="p">.</span><span class="nx">xml</span><span class="p">);</span> <span class="c1">// send XML output report to console</span>
<span class="p">}</span>

<span class="nx">test</span><span class="p">(</span><span class="s1">&#39;Check model initialization parameters and default values&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-2" id="section-2">&#182;</a>
</div>
<p>create a new instance of a User model </p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
    <span class="kd">var</span> <span class="nx">user</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">splat</span><span class="p">.</span><span class="nx">User</span><span class="p">({</span>
        <span class="nx">username</span><span class="o">:</span> <span class="s2">&quot;Noah&quot;</span><span class="p">,</span>
        <span class="nx">password</span><span class="o">:</span> <span class="s2">&quot;Jonah&quot;</span>
    <span class="p">});</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-3" id="section-3">&#182;</a>
</div>
<p>test that model has parameter attributes</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
    <span class="nx">equal</span><span class="p">(</span><span class="nx">user</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s2">&quot;username&quot;</span><span class="p">),</span> <span class="s2">&quot;Noah&quot;</span><span class="p">,</span> <span class="s2">&quot;User title set correctly&quot;</span><span class="p">);</span>
    <span class="nx">equal</span><span class="p">(</span><span class="nx">user</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s2">&quot;password&quot;</span><span class="p">),</span> <span class="s2">&quot;Jonah&quot;</span><span class="p">,</span> <span class="s2">&quot;User director set correctly&quot;</span><span class="p">);</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-4" id="section-4">&#182;</a>
</div>
<p>test that Movie model has correct default values upon instantiation</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
    <span class="kd">var</span> <span class="nx">movie</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">splat</span><span class="p">.</span><span class="nx">Movie</span><span class="p">();</span>
    <span class="nx">equal</span><span class="p">(</span><span class="nx">movie</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s2">&quot;poster&quot;</span><span class="p">),</span> <span class="s2">&quot;img/placeholder.png&quot;</span><span class="p">,</span>
        <span class="s2">&quot;Movie default value set correctly&quot;</span><span class="p">);</span>
<span class="p">});</span>

<span class="nx">test</span><span class="p">(</span><span class="s2">&quot;Inspect jQuery.getJSON&#39;s usage of jQuery.ajax&quot;</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">spy</span><span class="p">(</span><span class="nx">jQuery</span><span class="p">,</span> <span class="s2">&quot;ajax&quot;</span><span class="p">);</span>
    <span class="kd">var</span> <span class="nx">getJSONDone</span> <span class="o">=</span> <span class="nx">jQuery</span><span class="p">.</span><span class="nx">getJSON</span><span class="p">(</span><span class="s2">&quot;/movies&quot;</span><span class="p">);</span>
    <span class="nx">ok</span><span class="p">(</span><span class="nx">jQuery</span><span class="p">.</span><span class="nx">ajax</span><span class="p">.</span><span class="nx">calledOnce</span><span class="p">);</span>
    <span class="nx">equal</span><span class="p">(</span><span class="nx">jQuery</span><span class="p">.</span><span class="nx">ajax</span><span class="p">.</span><span class="nx">getCall</span><span class="p">(</span><span class="mi">0</span><span class="p">).</span><span class="nx">args</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">url</span><span class="p">,</span> <span class="s2">&quot;/movies&quot;</span><span class="p">);</span>
    <span class="nx">equal</span><span class="p">(</span><span class="nx">jQuery</span><span class="p">.</span><span class="nx">ajax</span><span class="p">.</span><span class="nx">getCall</span><span class="p">(</span><span class="mi">0</span><span class="p">).</span><span class="nx">args</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">dataType</span><span class="p">,</span> <span class="s2">&quot;json&quot;</span><span class="p">);</span>
<span class="p">});</span>

<span class="nx">test</span><span class="p">(</span><span class="s2">&quot;Fires a custom event when the state changes.&quot;</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">changeModelCallback</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">spy</span><span class="p">();</span>
    <span class="kd">var</span> <span class="nx">movie</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">splat</span><span class="p">.</span><span class="nx">Movie</span><span class="p">();</span>
    <span class="nx">movie</span><span class="p">.</span><span class="nx">bind</span><span class="p">(</span><span class="s2">&quot;change&quot;</span><span class="p">,</span> <span class="nx">changeModelCallback</span><span class="p">);</span>
    <span class="nx">movie</span><span class="p">.</span><span class="nx">set</span><span class="p">({</span>
        <span class="s2">&quot;title&quot;</span><span class="o">:</span> <span class="s2">&quot;Interstellar&quot;</span>
    <span class="p">});</span>
    <span class="nx">ok</span><span class="p">(</span><span class="nx">changeModelCallback</span><span class="p">.</span><span class="nx">calledOnce</span><span class="p">,</span>
        <span class="s2">&quot;A change event-callback was correctly triggered&quot;</span><span class="p">);</span>
<span class="p">});</span>
<span class="nx">test</span><span class="p">(</span><span class="s2">&quot;Test movie model/collection add/save, and callback functions.&quot;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">assert</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">assert</span><span class="p">.</span><span class="nx">expect</span><span class="p">(</span><span class="mi">4</span><span class="p">);</span> <span class="c1">// 4 assertions to be run</span>
    <span class="kd">var</span> <span class="nx">done1</span> <span class="o">=</span> <span class="nx">assert</span><span class="p">.</span><span class="nx">async</span><span class="p">();</span>
    <span class="kd">var</span> <span class="nx">done2</span> <span class="o">=</span> <span class="nx">assert</span><span class="p">.</span><span class="nx">async</span><span class="p">();</span>
    <span class="kd">var</span> <span class="nx">errorCallback</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">spy</span><span class="p">();</span>
    <span class="kd">var</span> <span class="nx">movie</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">splat</span><span class="p">.</span><span class="nx">Movie</span><span class="p">({</span>
        <span class="s2">&quot;__v&quot;</span><span class="o">:</span> <span class="mi">0</span><span class="p">,</span>
        <span class="s2">&quot;dated&quot;</span><span class="o">:</span> <span class="s2">&quot;2015-10-21T20:44:27.403Z&quot;</span><span class="p">,</span>
        <span class="s2">&quot;director&quot;</span><span class="o">:</span> <span class="s2">&quot;Sean Penn&quot;</span><span class="p">,</span>
        <span class="s2">&quot;duration&quot;</span><span class="o">:</span> <span class="mi">109</span><span class="p">,</span>
        <span class="s2">&quot;freshTotal&quot;</span><span class="o">:</span> <span class="mi">18</span><span class="p">,</span>
        <span class="s2">&quot;freshVotes&quot;</span><span class="o">:</span> <span class="mi">27</span><span class="p">,</span>
        <span class="s2">&quot;poster&quot;</span><span class="o">:</span> <span class="s2">&quot;img/placeholder.png&quot;</span><span class="p">,</span>
        <span class="s2">&quot;rating&quot;</span><span class="o">:</span> <span class="s2">&quot;R&quot;</span><span class="p">,</span>
        <span class="s2">&quot;released&quot;</span><span class="o">:</span> <span class="s2">&quot;1999&quot;</span><span class="p">,</span>
        <span class="s2">&quot;synopsis&quot;</span><span class="o">:</span> <span class="s2">&quot;great thriller&quot;</span><span class="p">,</span>
        <span class="s2">&quot;title&quot;</span><span class="o">:</span> <span class="s2">&quot;Zorba Games&quot;</span><span class="p">,</span>
        <span class="s2">&quot;trailer&quot;</span><span class="o">:</span> <span class="s2">&quot;http://archive.org&quot;</span><span class="p">,</span>
        <span class="s2">&quot;genre&quot;</span><span class="o">:</span> <span class="p">[</span><span class="s2">&quot;action&quot;</span><span class="p">],</span>
        <span class="s2">&quot;starring&quot;</span><span class="o">:</span> <span class="p">[</span><span class="s2">&quot;Bruce Willis&quot;</span><span class="p">,</span> <span class="s2">&quot;Amy Winemouse&quot;</span><span class="p">]</span>
    <span class="p">});</span> <span class="c1">// model</span>
    <span class="kd">var</span> <span class="nx">movies</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">splat</span><span class="p">.</span><span class="nx">Movies</span><span class="p">();</span> <span class="c1">// collection</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-5" id="section-5">&#182;</a>
</div>
<p>verify Movies-collection URL</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
    <span class="nx">equal</span><span class="p">(</span><span class="nx">movies</span><span class="p">.</span><span class="nx">url</span><span class="p">,</span> <span class="s2">&quot;/movies&quot;</span><span class="p">,</span>
        <span class="s2">&quot;correct URL set for instantiated Movies collection&quot;</span><span class="p">);</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-6" id="section-6">&#182;</a>
</div>
<p>test "add" event callback when movie added to collection</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
    <span class="kd">var</span> <span class="nx">addModelCallback</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">spy</span><span class="p">();</span>
    <span class="nx">movies</span><span class="p">.</span><span class="nx">bind</span><span class="p">(</span><span class="s2">&quot;add&quot;</span><span class="p">,</span> <span class="nx">addModelCallback</span><span class="p">);</span>
    <span class="nx">movies</span><span class="p">.</span><span class="nx">add</span><span class="p">(</span><span class="nx">movie</span><span class="p">);</span>
    <span class="nx">ok</span><span class="p">(</span><span class="nx">addModelCallback</span><span class="p">.</span><span class="nx">called</span><span class="p">,</span>
        <span class="s2">&quot;add callback triggered by movies collection add()&quot;</span><span class="p">);</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-7" id="section-7">&#182;</a>
</div>
<p>make sure user is logged out</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
    <span class="kd">var</span> <span class="nx">user</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">splat</span><span class="p">.</span><span class="nx">User</span><span class="p">({</span>
        <span class="nx">username</span><span class="o">:</span> <span class="s2">&quot;tester&quot;</span><span class="p">,</span>
        <span class="nx">password</span><span class="o">:</span> <span class="s2">&quot;tester&quot;</span>
    <span class="p">});</span>
    <span class="kd">var</span> <span class="nx">auth</span> <span class="o">=</span> <span class="nx">user</span><span class="p">.</span><span class="nx">save</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span> <span class="p">{</span>
        <span class="nx">type</span><span class="o">:</span> <span class="s1">&#39;put&#39;</span><span class="p">,</span>
        <span class="nx">success</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">model</span><span class="p">,</span> <span class="nx">resp</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">assert</span><span class="p">.</span><span class="nx">deepEqual</span><span class="p">(</span><span class="nx">resp</span><span class="p">,</span> <span class="p">{},</span> <span class="s2">&quot;Signout returns empty response object&quot;</span><span class="p">);</span>
            <span class="nx">done1</span><span class="p">();</span>
        <span class="p">}</span>
    <span class="p">});</span>
    <span class="nx">auth</span><span class="p">.</span><span class="nx">done</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
        <span class="nx">movie</span><span class="p">.</span><span class="nx">save</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span> <span class="p">{</span>
            <span class="nx">error</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">model</span><span class="p">,</span> <span class="nx">error</span><span class="p">)</span> <span class="p">{</span>
                <span class="nx">assert</span><span class="p">.</span><span class="nx">equal</span><span class="p">(</span><span class="nx">error</span><span class="p">.</span><span class="nx">status</span><span class="p">,</span> <span class="mi">403</span><span class="p">,</span>
                    <span class="s2">&quot;Saving without authentication returns 403 status&quot;</span><span class="p">);</span>
                <span class="nx">done2</span><span class="p">();</span>
            <span class="p">}</span>
        <span class="p">});</span>
    <span class="p">});</span>
<span class="p">});</span>

<span class="nx">test</span><span class="p">(</span><span class="s2">&quot;Test movie-delete triggers an error event if unauthenticated.&quot;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">assert</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">done1</span> <span class="o">=</span> <span class="nx">assert</span><span class="p">.</span><span class="nx">async</span><span class="p">();</span>
    <span class="kd">var</span> <span class="nx">done2</span> <span class="o">=</span> <span class="nx">assert</span><span class="p">.</span><span class="nx">async</span><span class="p">();</span>
    <span class="kd">var</span> <span class="nx">movie</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">splat</span><span class="p">.</span><span class="nx">Movie</span><span class="p">();</span> <span class="c1">// model</span>
    <span class="kd">var</span> <span class="nx">movies</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">splat</span><span class="p">.</span><span class="nx">Movies</span><span class="p">();</span> <span class="c1">// collection</span>
    <span class="nx">movies</span><span class="p">.</span><span class="nx">add</span><span class="p">(</span><span class="nx">movie</span><span class="p">);</span>
    <span class="nx">movie</span><span class="p">.</span><span class="nx">set</span><span class="p">({</span>
        <span class="s2">&quot;_id&quot;</span><span class="o">:</span> <span class="s2">&quot;557761f092e40db92c3ccdae&quot;</span>
    <span class="p">});</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-8" id="section-8">&#182;</a>
</div>
<p>make sure user is logged out</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
    <span class="kd">var</span> <span class="nx">user</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">splat</span><span class="p">.</span><span class="nx">User</span><span class="p">({</span>
        <span class="nx">username</span><span class="o">:</span> <span class="s2">&quot;tester&quot;</span><span class="p">,</span>
        <span class="nx">password</span><span class="o">:</span> <span class="s2">&quot;tester&quot;</span>
    <span class="p">});</span>
    <span class="kd">var</span> <span class="nx">auth</span> <span class="o">=</span> <span class="nx">user</span><span class="p">.</span><span class="nx">save</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span> <span class="p">{</span>
        <span class="nx">type</span><span class="o">:</span> <span class="s1">&#39;put&#39;</span><span class="p">,</span>
        <span class="nx">success</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">model</span><span class="p">,</span> <span class="nx">resp</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">assert</span><span class="p">.</span><span class="nx">deepEqual</span><span class="p">(</span><span class="nx">resp</span><span class="p">,</span> <span class="p">{},</span> <span class="s2">&quot;Signout returns empty response object&quot;</span><span class="p">);</span>
            <span class="nx">done1</span><span class="p">();</span>
        <span class="p">}</span>
    <span class="p">});</span>
    <span class="nx">auth</span><span class="p">.</span><span class="nx">done</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-9" id="section-9">&#182;</a>
</div>
<p>try to destroy an existing movie</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
        <span class="nx">movie</span><span class="p">.</span><span class="nx">destroy</span><span class="p">({</span>
            <span class="nx">error</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">model</span><span class="p">,</span> <span class="nx">resp</span><span class="p">)</span> <span class="p">{</span>
                <span class="nx">assert</span><span class="p">.</span><span class="nx">equal</span><span class="p">(</span><span class="nx">resp</span><span class="p">.</span><span class="nx">status</span><span class="p">,</span> <span class="mi">403</span><span class="p">,</span>
                    <span class="s2">&quot;Deleting without authentication returns 403 status code&quot;</span><span class="p">);</span>
                <span class="nx">done2</span><span class="p">();</span>
            <span class="p">}</span>
        <span class="p">});</span>
    <span class="p">});</span>
<span class="p">});</span>

<span class="nx">test</span><span class="p">(</span><span class="s2">&quot;Test movie create-delete succeeds in authenticated session.&quot;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">assert</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">assert</span><span class="p">.</span><span class="nx">expect</span><span class="p">(</span><span class="mi">4</span><span class="p">);</span>
    <span class="kd">var</span> <span class="nx">done1</span> <span class="o">=</span> <span class="nx">assert</span><span class="p">.</span><span class="nx">async</span><span class="p">();</span>
    <span class="kd">var</span> <span class="nx">done2</span> <span class="o">=</span> <span class="nx">assert</span><span class="p">.</span><span class="nx">async</span><span class="p">();</span>
    <span class="kd">var</span> <span class="nx">done3</span> <span class="o">=</span> <span class="nx">assert</span><span class="p">.</span><span class="nx">async</span><span class="p">();</span>
    <span class="kd">var</span> <span class="nx">done4</span> <span class="o">=</span> <span class="nx">assert</span><span class="p">.</span><span class="nx">async</span><span class="p">();</span>
    <span class="kd">var</span> <span class="nx">movie</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">splat</span><span class="p">.</span><span class="nx">Movie</span><span class="p">({</span>
        <span class="s2">&quot;__v&quot;</span><span class="o">:</span> <span class="mi">0</span><span class="p">,</span>
        <span class="s2">&quot;dated&quot;</span><span class="o">:</span> <span class="s2">&quot;2015-10-21T20:44:27.403Z&quot;</span><span class="p">,</span>
        <span class="s2">&quot;director&quot;</span><span class="o">:</span> <span class="s2">&quot;Sean Penn&quot;</span><span class="p">,</span>
        <span class="s2">&quot;duration&quot;</span><span class="o">:</span> <span class="mi">109</span><span class="p">,</span>
        <span class="s2">&quot;freshTotal&quot;</span><span class="o">:</span> <span class="mi">18</span><span class="p">,</span>
        <span class="s2">&quot;freshVotes&quot;</span><span class="o">:</span> <span class="mi">27</span><span class="p">,</span>
        <span class="s2">&quot;poster&quot;</span><span class="o">:</span> <span class="s2">&quot;img/placeholder.png&quot;</span><span class="p">,</span>
        <span class="s2">&quot;rating&quot;</span><span class="o">:</span> <span class="s2">&quot;R&quot;</span><span class="p">,</span>
        <span class="s2">&quot;released&quot;</span><span class="o">:</span> <span class="s2">&quot;1999&quot;</span><span class="p">,</span>
        <span class="s2">&quot;synopsis&quot;</span><span class="o">:</span> <span class="s2">&quot;great thriller&quot;</span><span class="p">,</span>
        <span class="s2">&quot;title&quot;</span><span class="o">:</span> <span class="s2">&quot;Zorba Games&quot;</span><span class="p">,</span>
        <span class="s2">&quot;trailer&quot;</span><span class="o">:</span> <span class="s2">&quot;http://archive.org&quot;</span><span class="p">,</span>
        <span class="s2">&quot;genre&quot;</span><span class="o">:</span> <span class="p">[</span><span class="s2">&quot;action&quot;</span><span class="p">],</span>
        <span class="s2">&quot;starring&quot;</span><span class="o">:</span> <span class="p">[</span><span class="s2">&quot;Bruce Willis&quot;</span><span class="p">,</span> <span class="s2">&quot;Amy Winemouse&quot;</span><span class="p">]</span>
    <span class="p">});</span> <span class="c1">// model</span>
    <span class="nx">movie</span><span class="p">.</span><span class="nx">urlRoot</span> <span class="o">=</span> <span class="s1">&#39;/movies&#39;</span><span class="p">;</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-10" id="section-10">&#182;</a>
</div>
<p>authenticate user with valid credentials</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
    <span class="kd">var</span> <span class="nx">user</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">splat</span><span class="p">.</span><span class="nx">User</span><span class="p">({</span>
        <span class="nx">username</span><span class="o">:</span> <span class="s2">&quot;tester&quot;</span><span class="p">,</span>
        <span class="nx">password</span><span class="o">:</span> <span class="s2">&quot;tester&quot;</span><span class="p">,</span>
        <span class="nx">login</span><span class="o">:</span> <span class="mi">1</span>
    <span class="p">});</span>
    <span class="kd">var</span> <span class="nx">auth</span> <span class="o">=</span> <span class="nx">user</span><span class="p">.</span><span class="nx">save</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span> <span class="p">{</span>
        <span class="nx">type</span><span class="o">:</span> <span class="s1">&#39;put&#39;</span><span class="p">,</span>
        <span class="nx">success</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">model</span><span class="p">,</span> <span class="nx">resp</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">assert</span><span class="p">.</span><span class="nx">equal</span><span class="p">(</span><span class="nx">resp</span><span class="p">.</span><span class="nx">username</span><span class="p">,</span> <span class="s2">&quot;tester&quot;</span><span class="p">,</span>
                <span class="s2">&quot;Successful login with valid credentials&quot;</span><span class="p">);</span>
            <span class="nx">done1</span><span class="p">();</span>
        <span class="p">}</span>
    <span class="p">});</span>
    <span class="kd">var</span> <span class="nx">saveMovie</span> <span class="o">=</span> <span class="nx">$</span><span class="p">.</span><span class="nx">Deferred</span><span class="p">();</span>
    <span class="nx">auth</span><span class="p">.</span><span class="nx">done</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-11" id="section-11">&#182;</a>
</div>
<p>create new movie model in DB</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
        <span class="nx">movie</span><span class="p">.</span><span class="nx">save</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span> <span class="p">{</span>
            <span class="nx">wait</span><span class="o">:</span> <span class="kc">true</span><span class="p">,</span>
            <span class="nx">success</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">model</span><span class="p">,</span> <span class="nx">resp</span><span class="p">)</span> <span class="p">{</span>
                <span class="nx">assert</span><span class="p">.</span><span class="nx">notEqual</span><span class="p">(</span><span class="nx">resp</span><span class="p">.</span><span class="nx">_id</span><span class="p">,</span> <span class="kc">undefined</span><span class="p">,</span>
                    <span class="s2">&quot;Saving new model succeeds when authenticated&quot;</span><span class="p">);</span>
                <span class="nx">saveMovie</span><span class="p">.</span><span class="nx">resolve</span><span class="p">();</span>
                <span class="nx">done2</span><span class="p">();</span>
            <span class="p">}</span>
        <span class="p">});</span>
    <span class="p">});</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-12" id="section-12">&#182;</a>
</div>
<p>when authentication and saving async calls have completed</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
    <span class="kd">var</span> <span class="nx">deleteMovie</span> <span class="o">=</span> <span class="nx">$</span><span class="p">.</span><span class="nx">Deferred</span><span class="p">();</span>
    <span class="nx">$</span><span class="p">.</span><span class="nx">when</span><span class="p">(</span><span class="nx">auth</span><span class="p">,</span> <span class="nx">saveMovie</span><span class="p">).</span><span class="nx">then</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-13" id="section-13">&#182;</a>
</div>
<p>attempt to delete newly-saved movie</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
        <span class="nx">movie</span><span class="p">.</span><span class="nx">destroy</span><span class="p">({</span>
            <span class="nx">success</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">model</span><span class="p">,</span> <span class="nx">resp</span><span class="p">)</span> <span class="p">{</span>
                <span class="nx">assert</span><span class="p">.</span><span class="nx">equal</span><span class="p">(</span><span class="nx">resp</span><span class="p">.</span><span class="nx">responseText</span><span class="p">,</span> <span class="s2">&quot;movie deleted&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;Deleting returns 200 status code&quot;</span><span class="p">);</span>
                <span class="nx">deleteMovie</span><span class="p">.</span><span class="nx">resolve</span><span class="p">();</span>
                <span class="nx">done3</span><span class="p">();</span>
            <span class="p">}</span>
        <span class="p">});</span>
    <span class="p">});</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-14" id="section-14">&#182;</a>
</div>
<p>attempt to delete a movie twice</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
    <span class="nx">$</span><span class="p">.</span><span class="nx">when</span><span class="p">(</span><span class="nx">deleteMovie</span><span class="p">).</span><span class="nx">then</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
        <span class="nx">movie</span><span class="p">.</span><span class="nx">destroy</span><span class="p">({</span>
            <span class="nx">error</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">model</span><span class="p">,</span> <span class="nx">resp</span><span class="p">)</span> <span class="p">{</span>
                <span class="nx">assert</span><span class="p">.</span><span class="nx">equal</span><span class="p">(</span><span class="nx">resp</span><span class="p">.</span><span class="nx">status</span><span class="p">,</span> <span class="mi">404</span><span class="p">,</span>
                    <span class="s2">&quot;Deleting deleted movie returns 404 status code&quot;</span><span class="p">);</span>
                <span class="nx">done4</span><span class="p">();</span>
            <span class="p">}</span>
        <span class="p">});</span>
    <span class="p">});</span>


<span class="p">});</span>


<span class="nx">test</span><span class="p">(</span><span class="s2">&quot;Test movie-save succeeds if session is authenticated.&quot;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">assert</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">assert</span><span class="p">.</span><span class="nx">expect</span><span class="p">(</span><span class="mi">2</span><span class="p">);</span>
    <span class="kd">var</span> <span class="nx">done1</span> <span class="o">=</span> <span class="nx">assert</span><span class="p">.</span><span class="nx">async</span><span class="p">();</span>
    <span class="kd">var</span> <span class="nx">done2</span> <span class="o">=</span> <span class="nx">assert</span><span class="p">.</span><span class="nx">async</span><span class="p">();</span>
    <span class="kd">var</span> <span class="nx">done3</span> <span class="o">=</span> <span class="nx">assert</span><span class="p">.</span><span class="nx">async</span><span class="p">();</span>
    <span class="kd">var</span> <span class="nx">done4</span> <span class="o">=</span> <span class="nx">assert</span><span class="p">.</span><span class="nx">async</span><span class="p">();</span>
    <span class="kd">var</span> <span class="nx">done5</span> <span class="o">=</span> <span class="nx">assert</span><span class="p">.</span><span class="nx">async</span><span class="p">();</span>
    <span class="kd">var</span> <span class="nx">movie</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">splat</span><span class="p">.</span><span class="nx">Movie</span><span class="p">({</span>
        <span class="s2">&quot;__v&quot;</span><span class="o">:</span> <span class="mi">0</span><span class="p">,</span>
        <span class="s2">&quot;dated&quot;</span><span class="o">:</span> <span class="s2">&quot;2015-10-21T20:44:27.403Z&quot;</span><span class="p">,</span>
        <span class="s2">&quot;director&quot;</span><span class="o">:</span> <span class="s2">&quot;Sean Penn&quot;</span><span class="p">,</span>
        <span class="s2">&quot;duration&quot;</span><span class="o">:</span> <span class="mi">109</span><span class="p">,</span>
        <span class="s2">&quot;freshTotal&quot;</span><span class="o">:</span> <span class="mi">18</span><span class="p">,</span>
        <span class="s2">&quot;freshVotes&quot;</span><span class="o">:</span> <span class="mi">27</span><span class="p">,</span>
        <span class="s2">&quot;poster&quot;</span><span class="o">:</span> <span class="s2">&quot;img/placeholder.png&quot;</span><span class="p">,</span>
        <span class="s2">&quot;rating&quot;</span><span class="o">:</span> <span class="s2">&quot;R&quot;</span><span class="p">,</span>
        <span class="s2">&quot;released&quot;</span><span class="o">:</span> <span class="s2">&quot;1999&quot;</span><span class="p">,</span>
        <span class="s2">&quot;synopsis&quot;</span><span class="o">:</span> <span class="s2">&quot;great thriller&quot;</span><span class="p">,</span>
        <span class="s2">&quot;title&quot;</span><span class="o">:</span> <span class="s2">&quot;Zorba Games&quot;</span><span class="p">,</span>
        <span class="s2">&quot;trailer&quot;</span><span class="o">:</span> <span class="s2">&quot;http://archive.org&quot;</span><span class="p">,</span>
        <span class="s2">&quot;genre&quot;</span><span class="o">:</span> <span class="p">[</span><span class="s2">&quot;action&quot;</span><span class="p">],</span>
        <span class="s2">&quot;starring&quot;</span><span class="o">:</span> <span class="p">[</span><span class="s2">&quot;Bruce Willis&quot;</span><span class="p">,</span> <span class="s2">&quot;Amy Winemouse&quot;</span><span class="p">]</span>
    <span class="p">});</span> <span class="c1">// model</span>
    <span class="nx">movie</span><span class="p">.</span><span class="nx">urlRoot</span> <span class="o">=</span> <span class="s1">&#39;/movies&#39;</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">movie2</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">splat</span><span class="p">.</span><span class="nx">Movie</span><span class="p">();</span> <span class="c1">// model</span>
    <span class="nx">movie2</span><span class="p">.</span><span class="nx">urlRoot</span> <span class="o">=</span> <span class="s1">&#39;/movies&#39;</span><span class="p">;</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-15" id="section-15">&#182;</a>
</div>
<p>authenticate user with valid credentials</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
    <span class="kd">var</span> <span class="nx">user</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">splat</span><span class="p">.</span><span class="nx">User</span><span class="p">({</span>
        <span class="nx">username</span><span class="o">:</span> <span class="s2">&quot;tester&quot;</span><span class="p">,</span>
        <span class="nx">password</span><span class="o">:</span> <span class="s2">&quot;tester&quot;</span><span class="p">,</span>
        <span class="nx">login</span><span class="o">:</span> <span class="mi">1</span>
    <span class="p">});</span>
    <span class="kd">var</span> <span class="nx">auth</span> <span class="o">=</span> <span class="nx">user</span><span class="p">.</span><span class="nx">save</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span> <span class="p">{</span>
        <span class="nx">type</span><span class="o">:</span> <span class="s1">&#39;put&#39;</span><span class="p">,</span>
        <span class="nx">success</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">model</span><span class="p">,</span> <span class="nx">resp</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">done1</span><span class="p">();</span>
        <span class="p">}</span>
    <span class="p">});</span>

    <span class="kd">var</span> <span class="nx">saveMovie</span> <span class="o">=</span> <span class="nx">$</span><span class="p">.</span><span class="nx">Deferred</span><span class="p">();</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-16" id="section-16">&#182;</a>
</div>
<p>create movie</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
    <span class="nx">auth</span><span class="p">.</span><span class="nx">done</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
        <span class="nx">movie</span><span class="p">.</span><span class="nx">save</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span> <span class="p">{</span>
            <span class="nx">wait</span><span class="o">:</span> <span class="kc">true</span><span class="p">,</span>
            <span class="nx">success</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">model</span><span class="p">,</span> <span class="nx">resp</span><span class="p">)</span> <span class="p">{</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-17" id="section-17">&#182;</a>
</div>
<p>set id for fetch to compare movie instance later</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
                <span class="nx">movie2</span><span class="p">.</span><span class="nx">set</span><span class="p">(</span><span class="s2">&quot;_id&quot;</span><span class="p">,</span> <span class="nx">movie</span><span class="p">.</span><span class="nx">id</span><span class="p">);</span>
                <span class="nx">saveMovie</span><span class="p">.</span><span class="nx">resolve</span><span class="p">();</span>
                <span class="nx">done2</span><span class="p">();</span>
            <span class="p">}</span>
        <span class="p">});</span>
    <span class="p">});</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-18" id="section-18">&#182;</a>
</div>
<p>update the movie</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
    <span class="kd">var</span> <span class="nx">updateMovie</span> <span class="o">=</span> <span class="nx">$</span><span class="p">.</span><span class="nx">Deferred</span><span class="p">();</span>
    <span class="nx">$</span><span class="p">.</span><span class="nx">when</span><span class="p">(</span><span class="nx">saveMovie</span><span class="p">).</span><span class="nx">then</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-19" id="section-19">&#182;</a>
</div>
<p>attempt to delete newly-saved movie</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
        <span class="nx">movie</span><span class="p">.</span><span class="nx">save</span><span class="p">({</span>
            <span class="s2">&quot;title&quot;</span><span class="o">:</span> <span class="s2">&quot;QUnit!&quot;</span>
        <span class="p">},</span> <span class="p">{</span>
            <span class="nx">success</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">model</span><span class="p">,</span> <span class="nx">resp</span><span class="p">)</span> <span class="p">{</span>
                <span class="nx">assert</span><span class="p">.</span><span class="nx">equal</span><span class="p">(</span><span class="nx">resp</span><span class="p">.</span><span class="nx">title</span><span class="p">,</span> <span class="s2">&quot;QUnit!&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;Saving model update succeeds when logged in&quot;</span><span class="p">);</span>
                <span class="nx">updateMovie</span><span class="p">.</span><span class="nx">resolve</span><span class="p">();</span>
                <span class="nx">done3</span><span class="p">();</span>
            <span class="p">}</span>
        <span class="p">});</span>
    <span class="p">});</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-20" id="section-20">&#182;</a>
</div>
<p>compare with new instance of movie to double check</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
    <span class="kd">var</span> <span class="nx">compareMovie</span> <span class="o">=</span> <span class="nx">$</span><span class="p">.</span><span class="nx">Deferred</span><span class="p">();</span>
    <span class="nx">$</span><span class="p">.</span><span class="nx">when</span><span class="p">(</span><span class="nx">updateMovie</span><span class="p">).</span><span class="nx">then</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-21" id="section-21">&#182;</a>
</div>
<p>attempt to delete newly-saved movie
fetch existing movie model</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
        <span class="nx">movie2</span><span class="p">.</span><span class="nx">fetch</span><span class="p">({</span>
            <span class="nx">success</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">model</span><span class="p">,</span> <span class="nx">resp</span><span class="p">)</span> <span class="p">{</span>
                <span class="nx">assert</span><span class="p">.</span><span class="nx">equal</span><span class="p">(</span><span class="nx">resp</span><span class="p">.</span><span class="nx">title</span><span class="p">,</span> <span class="s2">&quot;QUnit!&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;Successful updated model on server&quot;</span><span class="p">);</span>
                <span class="nx">compareMovie</span><span class="p">.</span><span class="nx">resolve</span><span class="p">();</span>
                <span class="nx">done4</span><span class="p">();</span>
            <span class="p">}</span>
        <span class="p">});</span>
    <span class="p">});</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-22" id="section-22">&#182;</a>
</div>
<p>delete movie</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
    <span class="nx">$</span><span class="p">.</span><span class="nx">when</span><span class="p">(</span><span class="nx">compareMovie</span><span class="p">).</span><span class="nx">then</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-23" id="section-23">&#182;</a>
</div>
<p>attempt to delete newly-saved movie</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
        <span class="nx">movie</span><span class="p">.</span><span class="nx">destroy</span><span class="p">({</span>
            <span class="nx">success</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">model</span><span class="p">,</span> <span class="nx">resp</span><span class="p">)</span> <span class="p">{</span>
                <span class="nx">done5</span><span class="p">();</span>
            <span class="p">}</span>
        <span class="p">});</span>
    <span class="p">});</span>

<span class="p">});</span>

<span class="nx">test</span><span class="p">(</span><span class="s2">&quot;Test review-create-delete if session is authenticated.&quot;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">assert</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">assert</span><span class="p">.</span><span class="nx">expect</span><span class="p">(</span><span class="mi">3</span><span class="p">);</span>
    <span class="kd">var</span> <span class="nx">done1</span> <span class="o">=</span> <span class="nx">assert</span><span class="p">.</span><span class="nx">async</span><span class="p">();</span>
    <span class="kd">var</span> <span class="nx">done2</span> <span class="o">=</span> <span class="nx">assert</span><span class="p">.</span><span class="nx">async</span><span class="p">();</span>
    <span class="kd">var</span> <span class="nx">done3</span> <span class="o">=</span> <span class="nx">assert</span><span class="p">.</span><span class="nx">async</span><span class="p">();</span>
    <span class="kd">var</span> <span class="nx">done4</span> <span class="o">=</span> <span class="nx">assert</span><span class="p">.</span><span class="nx">async</span><span class="p">();</span>
    <span class="kd">var</span> <span class="nx">done5</span> <span class="o">=</span> <span class="nx">assert</span><span class="p">.</span><span class="nx">async</span><span class="p">();</span>
    <span class="kd">var</span> <span class="nx">movie</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">splat</span><span class="p">.</span><span class="nx">Movie</span><span class="p">({</span>
        <span class="s2">&quot;__v&quot;</span><span class="o">:</span> <span class="mi">0</span><span class="p">,</span>
        <span class="s2">&quot;dated&quot;</span><span class="o">:</span> <span class="s2">&quot;2015-10-21T20:44:27.403Z&quot;</span><span class="p">,</span>
        <span class="s2">&quot;director&quot;</span><span class="o">:</span> <span class="s2">&quot;Sean Penn&quot;</span><span class="p">,</span>
        <span class="s2">&quot;duration&quot;</span><span class="o">:</span> <span class="mi">109</span><span class="p">,</span>
        <span class="s2">&quot;freshTotal&quot;</span><span class="o">:</span> <span class="mi">18</span><span class="p">,</span>
        <span class="s2">&quot;freshVotes&quot;</span><span class="o">:</span> <span class="mi">27</span><span class="p">,</span>
        <span class="s2">&quot;poster&quot;</span><span class="o">:</span> <span class="s2">&quot;img/placeholder.png&quot;</span><span class="p">,</span>
        <span class="s2">&quot;rating&quot;</span><span class="o">:</span> <span class="s2">&quot;R&quot;</span><span class="p">,</span>
        <span class="s2">&quot;released&quot;</span><span class="o">:</span> <span class="s2">&quot;1999&quot;</span><span class="p">,</span>
        <span class="s2">&quot;synopsis&quot;</span><span class="o">:</span> <span class="s2">&quot;great thriller&quot;</span><span class="p">,</span>
        <span class="s2">&quot;title&quot;</span><span class="o">:</span> <span class="s2">&quot;Zorba Games&quot;</span><span class="p">,</span>
        <span class="s2">&quot;trailer&quot;</span><span class="o">:</span> <span class="s2">&quot;http://archive.org&quot;</span><span class="p">,</span>
        <span class="s2">&quot;genre&quot;</span><span class="o">:</span> <span class="p">[</span><span class="s2">&quot;action&quot;</span><span class="p">],</span>
        <span class="s2">&quot;starring&quot;</span><span class="o">:</span> <span class="p">[</span><span class="s2">&quot;Bruce Willis&quot;</span><span class="p">,</span> <span class="s2">&quot;Amy Winemouse&quot;</span><span class="p">]</span>
    <span class="p">});</span> <span class="c1">// model</span>
    <span class="nx">movie</span><span class="p">.</span><span class="nx">urlRoot</span> <span class="o">=</span> <span class="s1">&#39;/movies&#39;</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">review</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">splat</span><span class="p">.</span><span class="nx">Review</span><span class="p">({</span>
        <span class="s2">&quot;freshness&quot;</span><span class="o">:</span> <span class="mi">0</span><span class="p">,</span>
        <span class="s2">&quot;reviewName&quot;</span><span class="o">:</span> <span class="s2">&quot;1&quot;</span><span class="p">,</span>
        <span class="s2">&quot;reviewAffil&quot;</span><span class="o">:</span> <span class="s2">&quot;1&quot;</span><span class="p">,</span>
        <span class="s2">&quot;reviewText&quot;</span><span class="o">:</span> <span class="s2">&quot;1&quot;</span><span class="p">,</span>
        <span class="s2">&quot;__v&quot;</span><span class="o">:</span> <span class="mi">0</span>
    <span class="p">});</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-24" id="section-24">&#182;</a>
</div>
<p>authenticate user with valid credentials</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
    <span class="kd">var</span> <span class="nx">user</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">splat</span><span class="p">.</span><span class="nx">User</span><span class="p">({</span>
        <span class="nx">username</span><span class="o">:</span> <span class="s2">&quot;tester&quot;</span><span class="p">,</span>
        <span class="nx">password</span><span class="o">:</span> <span class="s2">&quot;tester&quot;</span><span class="p">,</span>
        <span class="nx">login</span><span class="o">:</span> <span class="mi">1</span>
    <span class="p">});</span>
    <span class="kd">var</span> <span class="nx">auth</span> <span class="o">=</span> <span class="nx">user</span><span class="p">.</span><span class="nx">save</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span> <span class="p">{</span>
        <span class="nx">type</span><span class="o">:</span> <span class="s1">&#39;put&#39;</span><span class="p">,</span>
        <span class="nx">success</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">model</span><span class="p">,</span> <span class="nx">resp</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">done1</span><span class="p">();</span>
        <span class="p">}</span>
    <span class="p">});</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-25" id="section-25">&#182;</a>
</div>
<p>create movie</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
    <span class="kd">var</span> <span class="nx">saveMovie</span> <span class="o">=</span> <span class="nx">$</span><span class="p">.</span><span class="nx">Deferred</span><span class="p">();</span>
    <span class="nx">auth</span><span class="p">.</span><span class="nx">done</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
        <span class="nx">movie</span><span class="p">.</span><span class="nx">save</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span> <span class="p">{</span>
            <span class="nx">wait</span><span class="o">:</span> <span class="kc">true</span><span class="p">,</span>
            <span class="nx">success</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">model</span><span class="p">,</span> <span class="nx">resp</span><span class="p">)</span> <span class="p">{</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-26" id="section-26">&#182;</a>
</div>
<p>set id for fetch to compare movie instance later</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
                <span class="nx">review</span><span class="p">.</span><span class="nx">urlRoot</span> <span class="o">=</span> <span class="s1">&#39;/movies/&#39;</span> <span class="o">+</span> <span class="nx">movie</span><span class="p">.</span><span class="nx">id</span> <span class="o">+</span> <span class="s1">&#39;/reviews&#39;</span>
                <span class="nx">saveMovie</span><span class="p">.</span><span class="nx">resolve</span><span class="p">();</span>
                <span class="nx">done2</span><span class="p">();</span>
            <span class="p">}</span>
        <span class="p">});</span>
    <span class="p">});</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-27" id="section-27">&#182;</a>
</div>
<p>create review</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
    <span class="kd">var</span> <span class="nx">saveReview</span> <span class="o">=</span> <span class="nx">$</span><span class="p">.</span><span class="nx">Deferred</span><span class="p">();</span>
    <span class="nx">$</span><span class="p">.</span><span class="nx">when</span><span class="p">(</span><span class="nx">saveMovie</span><span class="p">).</span><span class="nx">then</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
        <span class="nx">review</span><span class="p">.</span><span class="nx">save</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span> <span class="p">{</span>
            <span class="nx">success</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">model</span><span class="p">,</span> <span class="nx">resp</span><span class="p">)</span> <span class="p">{</span>
                <span class="nx">assert</span><span class="p">.</span><span class="nx">notEqual</span><span class="p">(</span><span class="nx">resp</span><span class="p">.</span><span class="nx">_id</span><span class="p">,</span> <span class="kc">undefined</span><span class="p">,</span>
                    <span class="s2">&quot;Saving new review succeeds when authenticated&quot;</span><span class="p">);</span>

                <span class="nx">assert</span><span class="p">.</span><span class="nx">equal</span><span class="p">(</span><span class="nx">resp</span><span class="p">.</span><span class="nx">movieId</span><span class="p">,</span> <span class="nx">movie</span><span class="p">.</span><span class="nx">id</span><span class="p">,</span>
                    <span class="s2">&quot;associate new review to movie id successful&quot;</span><span class="p">);</span>
                <span class="nx">saveReview</span><span class="p">.</span><span class="nx">resolve</span><span class="p">();</span>
                <span class="nx">done3</span><span class="p">();</span>
            <span class="p">}</span>
        <span class="p">});</span>
    <span class="p">});</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-28" id="section-28">&#182;</a>
</div>
<p>delete movie</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
    <span class="kd">var</span> <span class="nx">deleteMovie</span> <span class="o">=</span> <span class="nx">$</span><span class="p">.</span><span class="nx">Deferred</span><span class="p">();</span>
    <span class="nx">$</span><span class="p">.</span><span class="nx">when</span><span class="p">(</span><span class="nx">saveReview</span><span class="p">).</span><span class="nx">then</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
        <span class="nx">movie</span><span class="p">.</span><span class="nx">destroy</span><span class="p">({</span>
            <span class="nx">success</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">model</span><span class="p">,</span> <span class="nx">resp</span><span class="p">)</span> <span class="p">{</span>
                <span class="nx">deleteMovie</span><span class="p">.</span><span class="nx">resolve</span><span class="p">();</span>
                <span class="nx">done4</span><span class="p">();</span>
            <span class="p">}</span>
        <span class="p">});</span>
    <span class="p">});</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-29" id="section-29">&#182;</a>
</div>
<p>check if review is deleted</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
    <span class="nx">$</span><span class="p">.</span><span class="nx">when</span><span class="p">(</span><span class="nx">deleteMovie</span><span class="p">).</span><span class="nx">then</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
        <span class="nx">review</span><span class="p">.</span><span class="nx">fetch</span><span class="p">({</span>
            <span class="nx">error</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">model</span><span class="p">,</span> <span class="nx">error</span><span class="p">)</span> <span class="p">{</span>
                <span class="nx">assert</span><span class="p">.</span><span class="nx">equal</span><span class="p">(</span><span class="nx">error</span><span class="p">.</span><span class="nx">status</span><span class="p">,</span> <span class="mi">404</span><span class="p">,</span>
                    <span class="s2">&quot;review fetch after movie delete returns 403 status&quot;</span><span class="p">);</span>
                <span class="nx">deleteMovie</span><span class="p">.</span><span class="nx">resolve</span><span class="p">();</span>
                <span class="nx">done5</span><span class="p">();</span>
            <span class="p">}</span>
        <span class="p">});</span>
    <span class="p">});</span>
<span class="p">});</span>


<span class="nx">test</span><span class="p">(</span><span class="s2">&quot;Test review-create if session is not authenticated.&quot;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">assert</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">assert</span><span class="p">.</span><span class="nx">expect</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
    <span class="kd">var</span> <span class="nx">done1</span> <span class="o">=</span> <span class="nx">assert</span><span class="p">.</span><span class="nx">async</span><span class="p">();</span>
    <span class="kd">var</span> <span class="nx">done2</span> <span class="o">=</span> <span class="nx">assert</span><span class="p">.</span><span class="nx">async</span><span class="p">();</span>
    <span class="kd">var</span> <span class="nx">done3</span> <span class="o">=</span> <span class="nx">assert</span><span class="p">.</span><span class="nx">async</span><span class="p">();</span>
    <span class="kd">var</span> <span class="nx">done4</span> <span class="o">=</span> <span class="nx">assert</span><span class="p">.</span><span class="nx">async</span><span class="p">();</span>
    <span class="kd">var</span> <span class="nx">done5</span> <span class="o">=</span> <span class="nx">assert</span><span class="p">.</span><span class="nx">async</span><span class="p">();</span>
    <span class="kd">var</span> <span class="nx">movie</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">splat</span><span class="p">.</span><span class="nx">Movie</span><span class="p">({</span>
        <span class="s2">&quot;__v&quot;</span><span class="o">:</span> <span class="mi">0</span><span class="p">,</span>
        <span class="s2">&quot;dated&quot;</span><span class="o">:</span> <span class="s2">&quot;2015-10-21T20:44:27.403Z&quot;</span><span class="p">,</span>
        <span class="s2">&quot;director&quot;</span><span class="o">:</span> <span class="s2">&quot;Sean Penn&quot;</span><span class="p">,</span>
        <span class="s2">&quot;duration&quot;</span><span class="o">:</span> <span class="mi">109</span><span class="p">,</span>
        <span class="s2">&quot;freshTotal&quot;</span><span class="o">:</span> <span class="mi">18</span><span class="p">,</span>
        <span class="s2">&quot;freshVotes&quot;</span><span class="o">:</span> <span class="mi">27</span><span class="p">,</span>
        <span class="s2">&quot;poster&quot;</span><span class="o">:</span> <span class="s2">&quot;img/placeholder.png&quot;</span><span class="p">,</span>
        <span class="s2">&quot;rating&quot;</span><span class="o">:</span> <span class="s2">&quot;R&quot;</span><span class="p">,</span>
        <span class="s2">&quot;released&quot;</span><span class="o">:</span> <span class="s2">&quot;1999&quot;</span><span class="p">,</span>
        <span class="s2">&quot;synopsis&quot;</span><span class="o">:</span> <span class="s2">&quot;great thriller&quot;</span><span class="p">,</span>
        <span class="s2">&quot;title&quot;</span><span class="o">:</span> <span class="s2">&quot;Zorba Games&quot;</span><span class="p">,</span>
        <span class="s2">&quot;trailer&quot;</span><span class="o">:</span> <span class="s2">&quot;http://archive.org&quot;</span><span class="p">,</span>
        <span class="s2">&quot;genre&quot;</span><span class="o">:</span> <span class="p">[</span><span class="s2">&quot;action&quot;</span><span class="p">],</span>
        <span class="s2">&quot;starring&quot;</span><span class="o">:</span> <span class="p">[</span><span class="s2">&quot;Bruce Willis&quot;</span><span class="p">,</span> <span class="s2">&quot;Amy Winemouse&quot;</span><span class="p">]</span>
    <span class="p">});</span> <span class="c1">// model</span>
    <span class="nx">movie</span><span class="p">.</span><span class="nx">urlRoot</span> <span class="o">=</span> <span class="s1">&#39;/movies&#39;</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">review</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">splat</span><span class="p">.</span><span class="nx">Review</span><span class="p">({</span>
        <span class="s2">&quot;freshness&quot;</span><span class="o">:</span> <span class="mi">0</span><span class="p">,</span>
        <span class="s2">&quot;reviewName&quot;</span><span class="o">:</span> <span class="s2">&quot;1&quot;</span><span class="p">,</span>
        <span class="s2">&quot;reviewAffil&quot;</span><span class="o">:</span> <span class="s2">&quot;1&quot;</span><span class="p">,</span>
        <span class="s2">&quot;reviewText&quot;</span><span class="o">:</span> <span class="s2">&quot;1&quot;</span><span class="p">,</span>
        <span class="s2">&quot;__v&quot;</span><span class="o">:</span> <span class="mi">0</span>
    <span class="p">});</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-30" id="section-30">&#182;</a>
</div>
<p>authenticate user with valid credentials</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
    <span class="kd">var</span> <span class="nx">user</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">splat</span><span class="p">.</span><span class="nx">User</span><span class="p">({</span>
        <span class="nx">username</span><span class="o">:</span> <span class="s2">&quot;tester&quot;</span><span class="p">,</span>
        <span class="nx">password</span><span class="o">:</span> <span class="s2">&quot;tester&quot;</span><span class="p">,</span>
        <span class="nx">login</span><span class="o">:</span> <span class="mi">1</span>
    <span class="p">});</span>
    <span class="kd">var</span> <span class="nx">auth</span> <span class="o">=</span> <span class="nx">user</span><span class="p">.</span><span class="nx">save</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span> <span class="p">{</span>
        <span class="nx">type</span><span class="o">:</span> <span class="s1">&#39;put&#39;</span><span class="p">,</span>
        <span class="nx">success</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">model</span><span class="p">,</span> <span class="nx">resp</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">done1</span><span class="p">();</span>
        <span class="p">}</span>
    <span class="p">});</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-31" id="section-31">&#182;</a>
</div>
<p>create movie</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
    <span class="kd">var</span> <span class="nx">saveMovie</span> <span class="o">=</span> <span class="nx">$</span><span class="p">.</span><span class="nx">Deferred</span><span class="p">();</span>
    <span class="nx">auth</span><span class="p">.</span><span class="nx">done</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
        <span class="nx">movie</span><span class="p">.</span><span class="nx">save</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span> <span class="p">{</span>
            <span class="nx">wait</span><span class="o">:</span> <span class="kc">true</span><span class="p">,</span>
            <span class="nx">success</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">model</span><span class="p">,</span> <span class="nx">resp</span><span class="p">)</span> <span class="p">{</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-32" id="section-32">&#182;</a>
</div>
<p>set id for fetch to compare movie instance later</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
                <span class="nx">review</span><span class="p">.</span><span class="nx">urlRoot</span> <span class="o">=</span> <span class="s1">&#39;/movies/&#39;</span> <span class="o">+</span> <span class="nx">movie</span><span class="p">.</span><span class="nx">id</span> <span class="o">+</span> <span class="s1">&#39;/reviews&#39;</span>
                <span class="nx">saveMovie</span><span class="p">.</span><span class="nx">resolve</span><span class="p">();</span>
                <span class="nx">done2</span><span class="p">();</span>
            <span class="p">}</span>
        <span class="p">});</span>
    <span class="p">});</span>
    <span class="kd">var</span> <span class="nx">saveReview</span> <span class="o">=</span> <span class="nx">$</span><span class="p">.</span><span class="nx">Deferred</span><span class="p">();</span>
    <span class="nx">$</span><span class="p">.</span><span class="nx">when</span><span class="p">(</span><span class="nx">saveMovie</span><span class="p">).</span><span class="nx">then</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-33" id="section-33">&#182;</a>
</div>
<p>make sure user is logged out</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
        <span class="nx">user</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">splat</span><span class="p">.</span><span class="nx">User</span><span class="p">({</span>
            <span class="nx">username</span><span class="o">:</span> <span class="s2">&quot;tester&quot;</span><span class="p">,</span>
            <span class="nx">password</span><span class="o">:</span> <span class="s2">&quot;tester&quot;</span>
        <span class="p">});</span>
        <span class="nx">auth</span> <span class="o">=</span> <span class="nx">user</span><span class="p">.</span><span class="nx">save</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span> <span class="p">{</span>
            <span class="nx">type</span><span class="o">:</span> <span class="s1">&#39;put&#39;</span><span class="p">,</span>
            <span class="nx">success</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">model</span><span class="p">,</span> <span class="nx">resp</span><span class="p">)</span> <span class="p">{</span>
                <span class="nx">done3</span><span class="p">();</span>
            <span class="p">}</span>
        <span class="p">});</span>
        <span class="nx">auth</span><span class="p">.</span><span class="nx">done</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-34" id="section-34">&#182;</a>
</div>
<p>try to destroy an existing movie</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
            <span class="nx">review</span><span class="p">.</span><span class="nx">save</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span> <span class="p">{</span>
                <span class="nx">error</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">model</span><span class="p">,</span> <span class="nx">error</span><span class="p">)</span> <span class="p">{</span>
                    <span class="nx">assert</span><span class="p">.</span><span class="nx">equal</span><span class="p">(</span><span class="nx">error</span><span class="p">.</span><span class="nx">status</span><span class="p">,</span> <span class="mi">403</span><span class="p">,</span>
                        <span class="s2">&quot;Saving review without authentication returns 403 status&quot;</span><span class="p">);</span>
                    <span class="nx">saveReview</span><span class="p">.</span><span class="nx">resolve</span><span class="p">();</span>
                    <span class="nx">done4</span><span class="p">();</span>
                <span class="p">}</span>
            <span class="p">});</span>
        <span class="p">});</span>
    <span class="p">});</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-35" id="section-35">&#182;</a>
</div>
<p>delete movie</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
    <span class="nx">$</span><span class="p">.</span><span class="nx">when</span><span class="p">(</span><span class="nx">saveReview</span><span class="p">).</span><span class="nx">then</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-36" id="section-36">&#182;</a>
</div>
<p>attempt to delete newly-saved movie</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
        <span class="nx">user</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">splat</span><span class="p">.</span><span class="nx">User</span><span class="p">({</span>
            <span class="nx">username</span><span class="o">:</span> <span class="s2">&quot;tester&quot;</span><span class="p">,</span>
            <span class="nx">password</span><span class="o">:</span> <span class="s2">&quot;tester&quot;</span><span class="p">,</span>
            <span class="nx">login</span><span class="o">:</span> <span class="mi">1</span>
        <span class="p">});</span>
        <span class="nx">auth</span> <span class="o">=</span> <span class="nx">user</span><span class="p">.</span><span class="nx">save</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span> <span class="p">{</span>
            <span class="nx">type</span><span class="o">:</span> <span class="s1">&#39;put&#39;</span><span class="p">,</span>
            <span class="nx">success</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">model</span><span class="p">,</span> <span class="nx">resp</span><span class="p">)</span> <span class="p">{</span>
                <span class="nx">movie</span><span class="p">.</span><span class="nx">destroy</span><span class="p">({</span>
                    <span class="nx">success</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">model</span><span class="p">,</span> <span class="nx">resp</span><span class="p">)</span> <span class="p">{</span>
                        <span class="nx">done5</span><span class="p">();</span>
                    <span class="p">}</span>
                <span class="p">});</span>
            <span class="p">}</span>
        <span class="p">});</span>
    <span class="p">});</span>

<span class="p">});</span>

<span class="nx">test</span><span class="p">(</span><span class="s2">&quot;Test movie schema validation in authenticated session.&quot;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">assert</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">assert</span><span class="p">.</span><span class="nx">expect</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
    <span class="kd">var</span> <span class="nx">done1</span> <span class="o">=</span> <span class="nx">assert</span><span class="p">.</span><span class="nx">async</span><span class="p">();</span>
    <span class="kd">var</span> <span class="nx">done2</span> <span class="o">=</span> <span class="nx">assert</span><span class="p">.</span><span class="nx">async</span><span class="p">();</span>
    <span class="kd">var</span> <span class="nx">movie</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">splat</span><span class="p">.</span><span class="nx">Movie</span><span class="p">({</span>
        <span class="s2">&quot;__v&quot;</span><span class="o">:</span> <span class="mi">0</span><span class="p">,</span>
        <span class="s2">&quot;dated&quot;</span><span class="o">:</span> <span class="s2">&quot;2015-10-21T20:44:27.403Z&quot;</span><span class="p">,</span>
        <span class="s2">&quot;director&quot;</span><span class="o">:</span> <span class="s2">&quot;Sean Penn&quot;</span><span class="p">,</span>
        <span class="s2">&quot;duration&quot;</span><span class="o">:</span> <span class="mi">109</span><span class="p">,</span>
        <span class="s2">&quot;freshTotal&quot;</span><span class="o">:</span> <span class="mi">18</span><span class="p">,</span>
        <span class="s2">&quot;freshVotes&quot;</span><span class="o">:</span> <span class="mi">27</span><span class="p">,</span>
        <span class="s2">&quot;poster&quot;</span><span class="o">:</span> <span class="s2">&quot;img/placeholder.png&quot;</span><span class="p">,</span>
        <span class="s2">&quot;rating&quot;</span><span class="o">:</span> <span class="s2">&quot;R&quot;</span><span class="p">,</span>
        <span class="s2">&quot;released&quot;</span><span class="o">:</span> <span class="s2">&quot;1999&quot;</span><span class="p">,</span>
        <span class="s2">&quot;synopsis&quot;</span><span class="o">:</span> <span class="s2">&quot;great thriller&quot;</span><span class="p">,</span>
        <span class="s2">&quot;title&quot;</span><span class="o">:</span> <span class="s2">&quot;Zorba Games&quot;</span><span class="p">,</span>
        <span class="s2">&quot;trailer&quot;</span><span class="o">:</span> <span class="s2">&quot;http://archive.org&quot;</span><span class="p">,</span>
        <span class="s2">&quot;genre&quot;</span><span class="o">:</span> <span class="p">[</span><span class="s2">&quot;action&quot;</span><span class="p">]</span>
    <span class="p">});</span> <span class="c1">// model</span>
    <span class="nx">movie</span><span class="p">.</span><span class="nx">urlRoot</span> <span class="o">=</span> <span class="s1">&#39;/movies&#39;</span><span class="p">;</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-37" id="section-37">&#182;</a>
</div>
<p>authenticate user with valid credentials</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
    <span class="kd">var</span> <span class="nx">user</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">splat</span><span class="p">.</span><span class="nx">User</span><span class="p">({</span>
        <span class="nx">username</span><span class="o">:</span> <span class="s2">&quot;tester&quot;</span><span class="p">,</span>
        <span class="nx">password</span><span class="o">:</span> <span class="s2">&quot;tester&quot;</span><span class="p">,</span>
        <span class="nx">login</span><span class="o">:</span> <span class="mi">1</span>
    <span class="p">});</span>
    <span class="kd">var</span> <span class="nx">auth</span> <span class="o">=</span> <span class="nx">user</span><span class="p">.</span><span class="nx">save</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span> <span class="p">{</span>
        <span class="nx">type</span><span class="o">:</span> <span class="s1">&#39;put&#39;</span><span class="p">,</span>
        <span class="nx">success</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">model</span><span class="p">,</span> <span class="nx">resp</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">done1</span><span class="p">();</span>
        <span class="p">}</span>
    <span class="p">});</span>
    <span class="nx">auth</span><span class="p">.</span><span class="nx">done</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-38" id="section-38">&#182;</a>
</div>
<p>create new movie model in DB</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
        <span class="nx">movie</span><span class="p">.</span><span class="nx">save</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span> <span class="p">{</span>
            <span class="nx">wait</span><span class="o">:</span> <span class="kc">true</span><span class="p">,</span>
            <span class="nx">error</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">model</span><span class="p">,</span> <span class="nx">error</span><span class="p">)</span> <span class="p">{</span>
                <span class="nx">ok</span><span class="p">(</span><span class="kc">true</span><span class="p">,</span> <span class="s2">&quot;Save not worked and returns error&quot;</span><span class="p">);</span>
                <span class="nx">done2</span><span class="p">();</span>
            <span class="p">}</span>
        <span class="p">});</span>

    <span class="p">});</span>
<span class="p">});</span>

<span class="nx">test</span><span class="p">(</span><span class="s2">&quot;Test movie dup constaints in authenticated session.&quot;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">assert</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">assert</span><span class="p">.</span><span class="nx">expect</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
    <span class="kd">var</span> <span class="nx">done1</span> <span class="o">=</span> <span class="nx">assert</span><span class="p">.</span><span class="nx">async</span><span class="p">();</span>
    <span class="kd">var</span> <span class="nx">done2</span> <span class="o">=</span> <span class="nx">assert</span><span class="p">.</span><span class="nx">async</span><span class="p">();</span>
    <span class="kd">var</span> <span class="nx">done3</span> <span class="o">=</span> <span class="nx">assert</span><span class="p">.</span><span class="nx">async</span><span class="p">();</span>
    <span class="kd">var</span> <span class="nx">done4</span> <span class="o">=</span> <span class="nx">assert</span><span class="p">.</span><span class="nx">async</span><span class="p">();</span>
    <span class="kd">var</span> <span class="nx">movie</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">splat</span><span class="p">.</span><span class="nx">Movie</span><span class="p">({</span>
        <span class="s2">&quot;__v&quot;</span><span class="o">:</span> <span class="mi">0</span><span class="p">,</span>
        <span class="s2">&quot;dated&quot;</span><span class="o">:</span> <span class="s2">&quot;2015-10-21T20:44:27.403Z&quot;</span><span class="p">,</span>
        <span class="s2">&quot;director&quot;</span><span class="o">:</span> <span class="s2">&quot;Sean Penn&quot;</span><span class="p">,</span>
        <span class="s2">&quot;duration&quot;</span><span class="o">:</span> <span class="mi">109</span><span class="p">,</span>
        <span class="s2">&quot;freshTotal&quot;</span><span class="o">:</span> <span class="mi">18</span><span class="p">,</span>
        <span class="s2">&quot;freshVotes&quot;</span><span class="o">:</span> <span class="mi">27</span><span class="p">,</span>
        <span class="s2">&quot;poster&quot;</span><span class="o">:</span> <span class="s2">&quot;img/placeholder.png&quot;</span><span class="p">,</span>
        <span class="s2">&quot;rating&quot;</span><span class="o">:</span> <span class="s2">&quot;R&quot;</span><span class="p">,</span>
        <span class="s2">&quot;released&quot;</span><span class="o">:</span> <span class="s2">&quot;1999&quot;</span><span class="p">,</span>
        <span class="s2">&quot;synopsis&quot;</span><span class="o">:</span> <span class="s2">&quot;great thriller&quot;</span><span class="p">,</span>
        <span class="s2">&quot;title&quot;</span><span class="o">:</span> <span class="s2">&quot;Zorba Games&quot;</span><span class="p">,</span>
        <span class="s2">&quot;trailer&quot;</span><span class="o">:</span> <span class="s2">&quot;http://archive.org&quot;</span><span class="p">,</span>
        <span class="s2">&quot;genre&quot;</span><span class="o">:</span> <span class="p">[</span><span class="s2">&quot;action&quot;</span><span class="p">],</span>
        <span class="s2">&quot;starring&quot;</span><span class="o">:</span> <span class="p">[</span><span class="s2">&quot;Bruce Willis&quot;</span><span class="p">,</span> <span class="s2">&quot;Amy Winemouse&quot;</span><span class="p">]</span>
    <span class="p">});</span> <span class="c1">// model</span>
    <span class="kd">var</span> <span class="nx">dupMovie</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">splat</span><span class="p">.</span><span class="nx">Movie</span><span class="p">({</span>
        <span class="s2">&quot;__v&quot;</span><span class="o">:</span> <span class="mi">0</span><span class="p">,</span>
        <span class="s2">&quot;dated&quot;</span><span class="o">:</span> <span class="s2">&quot;2015-10-21T20:44:27.403Z&quot;</span><span class="p">,</span>
        <span class="s2">&quot;director&quot;</span><span class="o">:</span> <span class="s2">&quot;Sean Penn&quot;</span><span class="p">,</span>
        <span class="s2">&quot;duration&quot;</span><span class="o">:</span> <span class="mi">109</span><span class="p">,</span>
        <span class="s2">&quot;freshTotal&quot;</span><span class="o">:</span> <span class="mi">18</span><span class="p">,</span>
        <span class="s2">&quot;freshVotes&quot;</span><span class="o">:</span> <span class="mi">27</span><span class="p">,</span>
        <span class="s2">&quot;poster&quot;</span><span class="o">:</span> <span class="s2">&quot;img/placeholder.png&quot;</span><span class="p">,</span>
        <span class="s2">&quot;rating&quot;</span><span class="o">:</span> <span class="s2">&quot;R&quot;</span><span class="p">,</span>
        <span class="s2">&quot;released&quot;</span><span class="o">:</span> <span class="s2">&quot;1999&quot;</span><span class="p">,</span>
        <span class="s2">&quot;synopsis&quot;</span><span class="o">:</span> <span class="s2">&quot;great thriller&quot;</span><span class="p">,</span>
        <span class="s2">&quot;title&quot;</span><span class="o">:</span> <span class="s2">&quot;Zorba Games&quot;</span><span class="p">,</span>
        <span class="s2">&quot;trailer&quot;</span><span class="o">:</span> <span class="s2">&quot;http://archive.org&quot;</span><span class="p">,</span>
        <span class="s2">&quot;genre&quot;</span><span class="o">:</span> <span class="p">[</span><span class="s2">&quot;action&quot;</span><span class="p">],</span>
        <span class="s2">&quot;starring&quot;</span><span class="o">:</span> <span class="p">[</span><span class="s2">&quot;Bruce Willis&quot;</span><span class="p">,</span> <span class="s2">&quot;Amy Winemouse&quot;</span><span class="p">]</span>
    <span class="p">});</span> <span class="c1">// dup model</span>
    <span class="nx">movie</span><span class="p">.</span><span class="nx">urlRoot</span> <span class="o">=</span> <span class="s1">&#39;/movies&#39;</span><span class="p">;</span>
    <span class="nx">dupMovie</span><span class="p">.</span><span class="nx">urlRoot</span> <span class="o">=</span> <span class="s1">&#39;/movies&#39;</span><span class="p">;</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-39" id="section-39">&#182;</a>
</div>
<p>authenticate user with valid credentials</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
    <span class="kd">var</span> <span class="nx">user</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">splat</span><span class="p">.</span><span class="nx">User</span><span class="p">({</span>
        <span class="nx">username</span><span class="o">:</span> <span class="s2">&quot;tester&quot;</span><span class="p">,</span>
        <span class="nx">password</span><span class="o">:</span> <span class="s2">&quot;tester&quot;</span><span class="p">,</span>
        <span class="nx">login</span><span class="o">:</span> <span class="mi">1</span>
    <span class="p">});</span>
    <span class="kd">var</span> <span class="nx">auth</span> <span class="o">=</span> <span class="nx">user</span><span class="p">.</span><span class="nx">save</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span> <span class="p">{</span>
        <span class="nx">type</span><span class="o">:</span> <span class="s1">&#39;put&#39;</span><span class="p">,</span>
        <span class="nx">success</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">model</span><span class="p">,</span> <span class="nx">resp</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">done1</span><span class="p">();</span>
        <span class="p">}</span>
    <span class="p">});</span>
    <span class="kd">var</span> <span class="nx">saveMovie</span> <span class="o">=</span> <span class="nx">$</span><span class="p">.</span><span class="nx">Deferred</span><span class="p">();</span>
    <span class="nx">auth</span><span class="p">.</span><span class="nx">done</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-40" id="section-40">&#182;</a>
</div>
<p>create new movie model in DB</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
        <span class="nx">movie</span><span class="p">.</span><span class="nx">save</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span> <span class="p">{</span>
            <span class="nx">wait</span><span class="o">:</span> <span class="kc">true</span><span class="p">,</span>
            <span class="nx">success</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">model</span><span class="p">,</span> <span class="nx">error</span><span class="p">)</span> <span class="p">{</span>
                <span class="nx">saveMovie</span><span class="p">.</span><span class="nx">resolve</span><span class="p">();</span>
                <span class="nx">done2</span><span class="p">();</span>
            <span class="p">}</span>
        <span class="p">});</span>
    <span class="p">});</span>
    <span class="kd">var</span> <span class="nx">saveDupMovie</span> <span class="o">=</span> <span class="nx">$</span><span class="p">.</span><span class="nx">Deferred</span><span class="p">();</span>
    <span class="nx">$</span><span class="p">.</span><span class="nx">when</span><span class="p">(</span><span class="nx">saveMovie</span><span class="p">).</span><span class="nx">then</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-41" id="section-41">&#182;</a>
</div>
<p>attempt to delete newly-saved movie</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
        <span class="nx">dupMovie</span><span class="p">.</span><span class="nx">save</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span> <span class="p">{</span>
            <span class="nx">wait</span><span class="o">:</span> <span class="kc">true</span><span class="p">,</span>
            <span class="nx">error</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">model</span><span class="p">,</span> <span class="nx">error</span><span class="p">)</span> <span class="p">{</span>
                <span class="nx">assert</span><span class="p">.</span><span class="nx">equal</span><span class="p">(</span><span class="nx">error</span><span class="p">.</span><span class="nx">status</span><span class="p">,</span> <span class="mi">403</span><span class="p">,</span>
                    <span class="s2">&quot;Saving duplicate returns 403 status&quot;</span><span class="p">);</span>
                <span class="nx">saveDupMovie</span><span class="p">.</span><span class="nx">resolve</span><span class="p">();</span>
                <span class="nx">done3</span><span class="p">();</span>
            <span class="p">}</span>
        <span class="p">});</span>
    <span class="p">});</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-42" id="section-42">&#182;</a>
</div>
<p>check if review is deleted</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
    <span class="nx">$</span><span class="p">.</span><span class="nx">when</span><span class="p">(</span><span class="nx">saveDupMovie</span><span class="p">).</span><span class="nx">then</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
        <span class="nx">movie</span><span class="p">.</span><span class="nx">destroy</span><span class="p">({</span>
            <span class="nx">success</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">model</span><span class="p">,</span> <span class="nx">resp</span><span class="p">)</span> <span class="p">{</span>
                <span class="nx">done4</span><span class="p">();</span>
            <span class="p">}</span>
        <span class="p">});</span>
    <span class="p">});</span>
<span class="p">});</span>
</pre></div>
        </td>
      </tr>
  </tbody>
</table>
  </div>
</body>
</html>
