/*! splat 2015-12-02 */
"use strict";var splat=splat||{};splat.utils={showNotice:function(a,b,c){$("#notification-panel").removeClass("alert-danger alert-warning alert-success alert-info"),$("#notification-panel").addClass("alert "+c),$("#notification-panel").html("<strong>"+a+"</strong> "+b),$("#notification-panel").stop(!0,!0).show().fadeOut(5e3)},hideNotice:function(){$("#notification-panel").stop(!0,!0).hide()},requestFailed:function(a){console.log(a),this.showNotice("Error",a.responseText,"alert-danger")},displayValidationErrors:function(a){for(var b in a)a.hasOwnProperty(b)&&this.addValidationError(b,a[b]);this.showNotice("Error!","Fix validation errors and try again","alert-danger")},addValidationError:function(a,b){var c=$(".form-group").find("input[name="+a+"], textarea[name="+a+"]").parent().parent();c.addClass("has-error"),$(".help-block",c).html(b)},removeValidationError:function(a){var b=$(".form-group").find("input[name="+a+"], textarea[name="+a+"]").parent().parent();b.removeClass("has-error"),$(".help-block",b).html("")},templateHelpers:{getReviewImage:function(a,b){return a/b>=.5?"/img/fresh_lg.png":"/img/rotten_lg.png"},getReviewText:function(a,b){return(a/b*100).toFixed(1)+"% ("+b+")"},formatArray:function(a){return a.join(", ")},getTrailer:function(a,b){return b?b:"movies/"+a+"/video"}},loadTemplates:function(a,b){var c=[],d=this;$.each(a,function(a,b){splat[b]?c.push($.get("tpl/"+b+".html",function(a){splat[b].prototype.template=function(b){return _.template(a)(_.extend(b,d.templateHelpers))}})):console.log(b+" not found")}),$.when.apply(null,c).done(b)}};var splat=splat||{};splat.Review=Backbone.Model.extend({idAttribute:"_id",defaults:{freshness:0,reviewName:"",reviewAffil:"",reviewText:"",movieId:void 0}});var splat=splat||{};splat.Movie=Backbone.Model.extend({idAttribute:"_id",defaults:{title:"",released:"",director:"",rating:"",starring:[],duration:void 0,genre:[],synopsis:"",freshTotal:0,freshVotes:0,trailer:"",poster:"img/placeholder.png",dated:new Date,userId:void 0},validators:{title:function(a){var b=/^[a-zA-Z0-9 \,\.\!\?\-\'\*]+$/;return a&&b.test(a)?{isValid:!0}:{isValid:!1,message:'You must enter a movie title. Only letters-digits-spaces and ",", ".", "!", "?", "-", "\'", "*" allowed'}},released:function(a){var b=/^(19[1-9]\d|20(1[0-6]|0\d))$/;return a&&b.test(a)?{isValid:!0}:{isValid:!1,message:"You must enter a year between 1910 and 2016"}},director:function(a){var b=/^[a-zA-Z0-9 \,\.\!\?\-\'\*]+$/;return a&&b.test(a)?{isValid:!0}:{isValid:!1,message:'You must enter a director\'s name. Only letters-digits-spaces and ",", ".", "!", "?", "-", "\'", "*" allowed'}},rating:function(a){var b=/^(G|PG|PG\-13|R|NC\-17|NR)$/;return a&&b.test(a)?{isValid:!0}:{isValid:!1,message:"You must enter one of G, PG, PG-13, R, NC-17, NR."}},starring:function(a){var b=/^[a-zA-Z \-\']+$/,c={isValid:!1,message:'You must enter atleast one actor\'s name. Only letters-spaces and "-", "\'"'};if(!(a instanceof Array)||0===a.length)return c;for(var d=0;d<a.length;d++)if(!a[d]||!b.test(a[d]))return c;return{isValid:!0}},duration:function(a){return!isNaN(a)&&a>=0&&999>=a?{isValid:!0}:{isValid:!1,message:"You must enter a duration between 0 and 999."}},genre:function(a){var b=/^[a-zA-Z \-\']+$/,c={isValid:!1,message:'You must enter atleast one movie genre. Only letters-spaces and "-", "\'"'};if(!(a instanceof Array)||0===a.length)return c;for(var d=0;d<a.length;d++)if(!a[d]||!b.test(a[d]))return c;return{isValid:!0}},synopsis:function(a){for(var b=/^[ \w\,\.\!\?\-\'\*]+$/,c={isValid:!1,message:'You must enter a synopsis. Only letters-digits-spaces and ",", ".", "!", "?", "-", "\'", "*" allowed. No blank lines.'},d=a.split("\n"),e=0;e<d.length;e++)if(!b.test(d[e]))return c;return{isValid:!0}},freshTotal:function(a){return!isNaN(a)&&a>=0?{isValid:!0}:{isValid:!1,message:"You must enter non-negative integer."}},freshVotes:function(a){return!isNaN(a)&&a>=0?{isValid:!0}:{isValid:!1,message:"You must enter non-negative integer."}},trailer:function(a){var b=/^(https?:\/\/[\w-]+(\.[\w-]+)+(:\d+)?(\/\S*)?)$/;return!a||b.test(a)?{isValid:!0}:{isValid:!1,message:"You must enter a valid trailer url"}},dated:function(a){var b=new Date(a);return a&&b instanceof Date&&!isNaN(b)?{isValid:!0}:{isValid:!1,message:"You must enter a valid dated date"}}},validateItem:function(a){return this.validators[a]?this.validators[a](this.get(a)):{isValid:!0}},validateAll:function(){var a={};for(var b in this.validators)if(this.validators.hasOwnProperty(b)){var c=this.validators[b](this.get(b));c.isValid===!1&&(a[b]=c.message)}return _.size(a)>0?{isValid:!1,messages:a}:{isValid:!0}}});var splat=splat||{};splat.User=Backbone.Model.extend({urlRoot:"/auth",idAttribute:"_id",initialize:function(){this.validators={},this.validators.username=function(a){return a&&a.length>0?{isValid:!0}:{isValid:!1,message:"username required"}},this.validators.email=function(a){return a&&a.length>0?{isValid:!0}:{isValid:!1,message:"email required"}},this.validators.password=function(a){return a&&a.length>0?{isValid:!0}:{isValid:!1,message:"password required"}},this.validators.password2=function(a){return a&&a.length>0?{isValid:!0}:{isValid:!1,message:"password required"}}},validateItem:function(a){return this.validators[a]?this.validators[a](this.get(a)):{isValid:!0}},validateAll:function(){var a={};for(var b in this.validators)if(this.validators.hasOwnProperty(b)){var c=this.validators[b](this.get(b));c.isValid===!1&&(a[b]=c.message)}return _.size(a)>0?{isValid:!1,messages:a}:{isValid:!0}}});var splat=splat||{};splat.Reviews=Backbone.Collection.extend({initialize:function(a){this.url="/movies/"+a+"/reviews",this.movieId=a},model:splat.Review});var splat=splat||{};splat.Movies=Backbone.Collection.extend({model:splat.Movie,url:"/movies"});var splat=splat||{};splat.Users=Backbone.Collection.extend({model:splat.User,url:"/auth"});var splat=splat||{};splat.About=Backbone.View.extend({render:function(){return this.$el.html(this.template()),this}});var splat=splat||{};splat.Details=Backbone.View.extend({initialize:function(){this.movieFormView=new splat.MovieForm({model:this.model}),this.moviePosterView=new splat.MoviePoster({model:this.model}),this.movieFormActionsView=new splat.MovieFormActions({model:this.model})},onClose:function(){this.movieFormView.close(),this.movieFormActionsView.close(),this.moviePosterView.close()},render:function(){return this.$el.html(this.template()),this.$("#movieposter").html(this.moviePosterView.render().el),this.$("#movieform").html(this.movieFormView.render().el),this.$("#movieformactions").html(this.movieFormActionsView.render().el),this}});var splat=splat||{};splat.Header=Backbone.View.extend({initialize:function(){this.listenTo(Backbone,"signedUp",this.signedUp),this.listenTo(Backbone,"signedIn",this.signedIn),this.listenTo(Backbone,"signedOut",this.signedOut)},events:{"change #orderForm":"sortOrder","mouseenter #orderdrop.active":"showOrderForm","mouseleave #orderdrop.active":"hideOrderForm","click #ordering":"showOrderForm"},authenticatedUI:function(a){this.$("#greet").html(a.username),this.$("#signoutUser").html("<b>"+a.username+"</b>"),this.$(".btn.signinSubmit").css("display","none"),this.$(".btn.signoutSubmit").css("display","block"),this.$("#addMovie").show()},signedUp:function(a){this.$("#signupdrop").removeClass("open"),this.$(".signinput").css("display","none"),this.$("#signupForm")[0].reset(),this.authenticatedUI(a)},signedIn:function(a){this.$("#signindrop").removeClass("open"),this.$('[class*="signin"]').css("display","none"),this.$("#signinForm")[0].reset(),this.authenticatedUI(a)},signedOut:function(){this.$("#greet").html("Sign In"),this.$("#signoutUser").html(""),this.$(".btn.signoutSubmit").css("display","none"),this.$(".btn.signinSubmit").css("display","block"),this.$('[class*="signin"]').css("display","block"),this.$("#signindrop").removeClass("open"),this.$("#addMovie").hide()},showOrderForm:function(){this.$("#orderdrop").addClass("open")},hideOrderForm:function(){this.$("#orderdrop").removeClass("open")},sortOrder:function(a){a.stopPropagation(),splat.order=a.target.value,Backbone.trigger("orderevent",a),this.hideOrderForm(a)},render:function(){this.$el.html(this.template());var a=new splat.User;return this.signupform=new splat.Signup({model:a}),this.$("#signupDiv").append(this.signupform.render().el),this.signinform=new splat.Signin({model:a}),this.$("#signinDiv").append(this.signinform.render().el),splat.auth&&this.signedIn({userid:splat.userid,username:splat.username}),this},selectMenuItem:function(a){$(".nav li").removeClass("active"),$(".nav a:contains("+a+")").parent().addClass("active")}});var splat=splat||{};splat.Home=Backbone.View.extend({render:function(){return this.$el.html(this.template()),this}});var splat=splat||{};splat.MovieThumb=Backbone.View.extend({});var splat=splat||{};splat.MovieForm=Backbone.View.extend({initialize:function(){},events:{"change .form-group input[type=text]":"change","change .form-group textarea":"change","change #selectVideo":"uploadVideo"},uploadVideo:function(a){if(a.target.files.length){if(a.target.files[0].size>5242880)return void splat.utils.showNotice("Warning","Video is too large!","alert-warning");if("video/mp4"!==a.target.files[0].type)return void splat.utils.showNotice("Warning","Video must be an mp4!","alert-warning");if(!this.model.id)return void splat.utils.showNotice("Warning","Please save the movie first","alert-warning");var b=this,c=new FormData;c.append("video",a.target.files[0]),$.ajax({url:"movies/"+b.model.id+"/video",type:"POST",data:c,processData:!1,contentType:!1,beforeSend:function(a){a.setRequestHeader("X-CSRF-Token",splat.token)},xhr:function(){var a=$.ajaxSettings.xhr();return a.upload&&($("input[name=trailer]").addClass("hidden"),$(".progress").removeClass("hidden"),a.upload.addEventListener("progress",function(a){var c=a.loaded/a.total*100;b.$(".progress-bar").css("width",c+"%").attr("aria-valuenow",c)})),a}}).done(function(a){$(".progress").addClass("hidden"),$("input[name=trailer]").removeClass("hidden");var c=_.escape(location.origin+a);$("input[name=trailer]").val(c),b.model.set({trailer:c}),splat.utils.showNotice("Note!","Video has been uploaded to server","alert-info")}).fail(function(a){splat.utils.requestFailed(a)})}},change:function(a){var b={},c=a.target.name,d=_.escape(a.target.value);"starring"===c||"genre"===c?b[c]=d.split(",").map(Function.prototype.call,String.prototype.trim):"duration"===c?b[c]=Number(d):b[c]=d,this.model.set(b),splat.utils.showNotice("Note!",'Movie Attribute updated, to make changes permanent, click "Save Changes" button',"alert-info");var e=this.model.validateItem(c);e.isValid?splat.utils.removeValidationError(c):splat.utils.addValidationError(c,e.message)},render:function(){return this.$el.html(this.template(this.model.toJSON())),this}});var splat=splat||{};splat.MovieFormActions=Backbone.View.extend({initialize:function(){this.isNew=this.model.isNew(),this.listenTo(this.model,"change:freshTotal",this.render)},events:{"click #moviesave":"beforeSave","click #moviedel":"destroy"},beforeSave:function(){var a=this.model.validateAll();return a.isValid===!1?(splat.utils.displayValidationErrors(a.messages),!1):void this.save()},save:function(){var a=this;this.model.collection.create(this.model,{wait:!0,success:function(b){var c=$("#detailsImage")[0];c.src=b.get("poster"),a.isNew&&splat.app.navigate("#movies/"+a.model.id,{replace:!0,trigger:!1}),splat.utils.showNotice("Success!","Movie saved","alert-success"),a.render()},error:function(a,b){splat.utils.requestFailed(b)}})},destroy:function(){this.model.destroy({wait:!0,success:function(){splat.app.navigate("#movies",{replace:!0,trigger:!0}),splat.utils.showNotice("Success","Movie deleted","alert-success")},error:function(a,b){splat.utils.requestFailed(b)}})},render:function(){return this.$el.html(this.template(this.model.toJSON())),this}});var splat=splat||{};splat.MoviePoster=Backbone.View.extend({initialize:function(){},events:{"change #selectImage":"selectImage","dragover #detailsImage":"dragoverHandler","drop #detailsImage":"dropHandler"},selectImage:function(a){this.pictureFile=a.target.files[0],0===this.pictureFile.type.indexOf("image/")?this.imageRead(this.pictureFile,this.pictureFile.type):splat.utils.showNotice("Error","Please select a valid image file","alert-danger")},imageRead:function(a,b){var c=this,d=new FileReader;d.onload=function(){c.resize(d.result,b,"0.9",function(a){c.model.set("poster",a);var b=$("#detailsImage")[0];b.src=a,splat.utils.showNotice("Note!",'Movie Poster updated, to make changes permanent, click "Save Changes" button',"alert-info")})},d.readAsDataURL(a)},dragoverHandler:function(a){a.stopPropagation(),a.preventDefault(),a.originalEvent.dataTransfer.dropEffect="copy"},dropHandler:function(a){a.currentTarget.className="",a.stopPropagation(),a.preventDefault();var b=a.originalEvent;this.pictureFile=b.dataTransfer.files[0],0===this.pictureFile.type.indexOf("image/")?this.imageRead(this.pictureFile,this.pictureFile.type):splat.utils.showNotice("Error","Please select a valid image file","alert-danger")},resize:function(a,b,c,d){var c=c||.95,e=new Image,f=255,g=450,h=0,i=0;e.onload=function(){e.width/e.height>g/f?(e.height=e.height*g/e.width,e.width=g,i=(f-e.height)/2):(e.width=e.width*f/e.height,e.height=f,h=(g-e.width)/2);var a=document.createElement("canvas");a.width=g,a.height=f;var b=a.getContext("2d");b.drawImage(e,h,i,e.width,e.height),d&&d(a.toDataURL("image/jpeg",c))},e.src=a},render:function(){return this.$el.html(this.template(this.model.toJSON())),this}});var splat=splat||{};splat.MoviesView=Backbone.View.extend({events:{"click .video-container":"playVideo"},initialize:function(){this.movieThumbView=new splat.MovieThumb,this.listenTo(Backbone,"orderevent",this.sort),this.listenTo(this.collection,"sync",this.render),this.sort()},playVideo:function(a){a.target.play()},moviesTemplate:_.template(["<% movies.each(function(movie) { %>","<%= movieTemplate(movie.toJSON()) %>","<% }); %>"].join("")),sort:function(){this.collection.comparator=function(a){return a.get(splat.order).toLowerCase()},this.collection.sort(),this.render()},render:function(){return $(this.el).html(this.moviesTemplate({movies:this.collection,movieTemplate:this.movieThumbView.template})),this.$(".trailer source").on("error",function(){splat.utils.showNotice("Error","Video not found","alert-danger")}),this.$('[data-toggle="tooltip"]').tooltip(),this}});var splat=splat||{};splat.ReviewThumb=Backbone.View.extend({});var splat=splat||{};splat.Reviewer=Backbone.View.extend({events:{"click #reviewsave":"save","change .form-group input":"change","change .form-group textarea":"change"},change:function(a){var b={};b[a.target.name]=_.escape(a.target.value),this.review.set(b)},save:function(){var a=this;this.collection.create(this.review,{wait:!0,success:function(){splat.utils.showNotice("Success","review has been saved","alert-success"),a.render()},error:function(a,b){splat.utils.requestFailed(b)}})},render:function(){return this.review=new splat.Review,this.$el.html(this.template(this.review.toJSON())),this}});var splat=splat||{};splat.ReviewsView=Backbone.View.extend({initialize:function(){this.reviewerView=new splat.Reviewer({collection:this.collection}),this.reviewThumbsView=new splat.ReviewThumbs({collection:this.collection}),this.listenTo(this.collection,"sync",function(){this.reviewThumbsView.render(),this.showScore()})},showScore:function(){var a=0;this.collection.each(function(b){a+=b.get("freshness")});var b=this.collection.length;b?(a/b>=.5?this.$("#freshnessimg").attr("src","/img/fresh.gif"):this.$("#freshnessimg").attr("src","/img/rotten.gif"),this.$("#freshness").html((a/b*100).toFixed(1)+"% ("+b+")")):this.$("#freshness").html("… no reviews yet")},onClose:function(){this.reviewerView.close(),this.reviewThumbsView.close()},render:function(){return this.$el.html(this.template()),this.$("#reviewer").html(this.reviewerView.render().el),this.$("#reviewthumbs").html(this.reviewThumbsView.render().el),this.showScore(),this}});var splat=splat||{};splat.ReviewThumbs=Backbone.View.extend({initialize:function(){this.reviewThumbView=new splat.ReviewThumb},reviewsTemplate:_.template(["<% reviews.each(function(review) { %>","<%= reviewTemplate(review.toJSON()) %>","<% }); %>"].join("")),render:function(){var a=this;return a.$el.html(a.reviewsTemplate({reviews:a.collection,reviewTemplate:a.reviewThumbView.template})),this}});var splat=splat||{};splat.Signin=Backbone.View.extend({el:'<form id="signinForm" accept-charset="UTF-8">',events:{"change .signinput":"change","click .signinSubmit":"signin","click .signoutSubmit":"signout"},render:function(){return this.$el.html(this.template(this.model.toJSON())),this},change:function(a){splat.utils.hideNotice(),this.model||(this.model=new splat.User);var b={};b[a.target.name]=a.target.value,this.model.set(b);var c=this.model.validateItem(a.target.name);c.isValid?splat.utils.removeValidationError(a.target.name):splat.utils.addValidationError(a.target.name,c.message)},signin:function(a){a.preventDefault();var b=this,c=b.model.validateItem("username");c.isValid?splat.utils.removeValidationError("username"):splat.utils.addValidationError("username",c.message);var d=b.model.validateItem("password");return d.isValid?splat.utils.removeValidationError("password"):splat.utils.addValidationError("password",d.message),c.isValid&&d.isValid?(this.model.set({login:1}),void this.model.save(null,{type:"put",wait:!0,success:function(a,b){console.log(a,b),b.error?splat.utils.showNotice("Signin Failed",b.error,"alert-danger"):(splat.userid=b.userid,splat.username=b.username,splat.utils.showNotice("Signin Successful!","Welcome back "+splat.username,"alert-success"),Backbone.trigger("signedIn",b))},error:function(a,b){splat.utils.showNotice("Error",b.responseText,"alert-danger")}})):!1},signout:function(a){a.preventDefault(),$("#logoutdrop").removeClass("open"),this.model.set({login:0,username:"",password:""}),this.model.save(null,{type:"put",success:function(a,b){splat.utils.showNotice("Signout Successful!","Please Come Back Soon","alert-success"),Backbone.trigger("signedOut",b)},error:function(a){splat.utils.showNotice("Error",a.responseText,"alert-danger")}})}});var splat=splat||{};splat.Signup=Backbone.View.extend({el:'<form id="signupForm" accept-charset="UTF-8">',events:{"change .signup":"change","click .signupSubmit":"signup"},render:function(){return this.$el.html(this.template(this.model.toJSON())),this},change:function(a){var b=this;splat.utils.hideNotice(),this.model||(this.model=new splat.User);var c={};c[a.target.name]=a.target.value,this.model.set(c);var d;"password"===a.target.name||"password2"===a.target.name?b.$("#signup_password").val()!==b.$("#signup_password2").val()?d={isValid:!1,message:"Password values must match"}:(d=this.model.validateItem(a.target.name),splat.utils.removeValidationError("password"),splat.utils.removeValidationError("password2")):d=this.model.validateItem(a.target.name),d.isValid?splat.utils.removeValidationError(a.target.name):splat.utils.addValidationError(a.target.name,d.message)},signup:function(a){a.preventDefault();var b=this,c=b.model.validateAll();return c.isValid===!1?(splat.utils.displayValidationErrors(c.messages),!1):void this.model.save(null,{wait:!0,success:function(a,b){b.error?splat.utils.showNotice("Signup Failed","Failed to create account","alert-danger"):(splat.userid=b.userid,splat.username=b.username,splat.utils.showNotice("Signup Successful!","Welcome "+splat.username,"alert-success"),Backbone.trigger("signedUp",b))},error:function(a,b){splat.utils.showNotice("Error",b.responseText,"alert-danger")}})}});var splat=splat||{};splat.AppRouter=Backbone.Router.extend({routes:{"":"home",about:"about",movies:"browse","movies/add":"addHandler","movies/:id":"editHandler","movies/:id/reviews":"reviews","*default":"home"},initialize:function(){this.movies=new splat.Movies,this.moviesFetch=this.movies.fetch(),splat.order="title";var a=new EventSource("/events"),b=this;a.onmessage=function(a){var c=JSON.parse(a.data);"movie"===c.model?b.moviesFetch=b.movies.fetch():"review"===c.model?(b.moviesFetch=b.movies.fetch(),b.moviesFetch.done(function(){var a=b.movies.get(c.movieId);a.reviews&&a.reviews.fetch()}).fail(function(a,b){splat.utils.requestFailed(b)})):console.log(c)},this.headerView=new splat.Header,$(".header").html(this.headerView.render().el)},showView:function(a,b){this.currentView&&this.currentView.close(),this.currentView=b,$(a).html(b.render().el).stop().hide().fadeIn(500)},home:function(){this.homeView||(this.homeView=new splat.Home),this.showView("#content",this.homeView),this.headerView.selectMenuItem("Splat!")},about:function(){this.aboutView||(this.aboutView=new splat.About),this.showView("#content",this.aboutView),this.headerView.selectMenuItem("About")},browse:function(){this.moviesFetch=this.movies.fetch();var a=this;this.moviesFetch.done(function(){a.moviesView=new splat.MoviesView({collection:a.movies}),a.showView("#content",a.moviesView),a.headerView.selectMenuItem("Browse Movies")}).fail(function(a,b){splat.utils.requestFailed(b)})},addHandler:function(){var a=new splat.Movie;a.collection=this.movies,this.detailsView=new splat.Details({model:a}),this.showView("#content",this.detailsView),this.headerView.selectMenuItem("Add Movie")},editHandler:function(a){var b=this;this.moviesFetch.done(function(){var c=b.movies.get(a);b.detailsView=new splat.Details({model:c}),b.showView("#content",b.detailsView),b.headerView.selectMenuItem("Add Movie")}).fail(function(a,b){splat.utils.requestFailed(b)})},reviews:function(a){var b=this;this.moviesFetch.done(function(){var c=b.movies.get(a);c.reviews||(c.reviews=new splat.Reviews(a));var d=c.reviews.fetch();d.done(function(){b.reviewsView=new splat.ReviewsView({collection:c.reviews}),b.showView("#content",b.reviewsView)}).fail(function(a,b){splat.utils.requestFailed(b)})}).fail(function(a,b){splat.utils.requestFailed(b)})}}),splat.utils.loadTemplates(["Home","Header","About","Details","MovieThumb","MovieForm","MovieFormActions","MoviePoster","ReviewsView","Reviewer","ReviewThumb","Signup","Signin"],function(){splat.app=new splat.AppRouter,Backbone.history.start()}),Backbone.View.prototype.close=function(){this.onClose&&this.onClose(),this.remove(),this.unbind()},Backbone.ajax=function(){return Backbone.$.ajaxSetup.call(Backbone.$,{beforeSend:function(a){a.setRequestHeader("X-CSRF-Token",splat.token)}}),Backbone.$.ajax.apply(Backbone.$,arguments)};